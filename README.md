# syte

## Быстрый старт

1. Скопируйте образцы переменных окружения:
   ```bash
   cp .env.example .env
   cp backend/.env.example backend/.env
   ```
   Значения в примерах безопасны для разработки; реальные секреты храните во внешнем хранилище или в приватных `.env` файлах, не попадающих в Git.
2. Соберите и поднимите стек (миграции применяются автоматически при старте `backend`):
   ```bash
   make up
   ```
   После старта прокси сайт будет доступен на `http://localhost/` (HTTPS-версия — `https://localhost/`).
   Приложение также отвечает напрямую по `http://localhost:8000/` — можно проверять health:
   ```bash
   curl -i http://localhost:8000/health
   curl -i http://localhost:8000/ready
   ```
3. Откройте сайт в браузере:
   ```bash
   make open
   ```
4. Следите за логами backend:
   ```bash
   make logs
   ```
5. Остановить или уничтожить окружение:
   ```bash
   make stop   # остановить контейнеры
   make down   # остановить и удалить контейнеры
   ```

## Наблюдаемость и логирование

- Приложение пишет JSON-логи в stdout. Каждый лог содержит поля `timestamp`, `level`, `message`, `request_id`, `method`, `path`, `status`, `duration_ms`, `client_ip`, `user_agent`.
- `X-Request-ID` проксируется из входящих запросов или генерируется автоматически. Значение доступно в `request.state.request_id` и присутствует во всех логах запроса.
- Прозрачный middleware фиксирует время обработки и исключения. Ошибки логируются с полноценным stacktrace.
- Сервис экспонирует метрики Prometheus на `/metrics`.
- Обратный прокси (nginx) завершает TLS, добавляет `X-Forwarded-*`, сжимает ответы (`gzip`/`brotli`), кеширует статику и ограничивает скорость (`429` при превышении лимитов).

## Конфигурация

- Все настройки задаются через типизированный `Settings` (`backend/settings.py`) и читаются из окружения.
- В репозитории лежат только образцы `.env.example`; настоящие `.env` игнорируются `.gitignore`.
- Основные параметры:
  - `DATABASE_URL`, `SECRET_KEY`, `REDIS_URL`, SMTP и S3 креденшелы;
  - таймауты и лог-уровень (`LOG_LEVEL`), заголовок для идентификатора запросов (`REQUEST_ID_HEADER`);
  - список доверенных прокси для заголовков `X-Forwarded-*` (`PROXY_TRUSTED_HOSTS`);
  - директории для статики и медиа (`MEDIA_DIR`, `STATIC_DIR`, `RESULTS_DIR`, `DOCS_DIR`).
- Смена значений в `.env` не требует правок кода – достаточно перезапустить контейнер.

## Процесс-менеджер и прокси

- Приложение запускается через `gunicorn` c воркерами `uvicorn`, дефолтное число воркеров вычисляется от числа CPU (минимум 2, максимум 8).
- Настройки `gunicorn` лежат в `backend/gunicorn_conf.py` и могут переопределяться переменными `GUNICORN_*`.
- На входе стоит `nginx` (см. `deploy/proxy`). Для разработки он генерирует self-signed сертификат (`dev.crt`/`dev.key`); для продакшна достаточно смонтировать свои файлы в `deploy/certs`.

## Команды разработчика

- `make install-dev` – установка зависимостей для разработки (`ruff`, `mypy`, `pytest`, `pre-commit`).
- `make format` / `make lint` / `make typecheck` / `make test` – отдельные проверки.
- `make check` – форматирование (в режиме проверки), линт, типизация и тесты за один прогон.
- Рекомендуется установить `pre-commit` (`pre-commit install`) – перед коммитом автоматически выполнятся `ruff`, `mypy`, `pytest`.

## Полезные URL

- Приложение: `https://localhost/` (или `http://localhost/`).
- Прямой доступ к backend: `http://localhost:8000/`.
- Промышленный health-check: `http://localhost:8000/health` (готовность — `/ready`).
- Метрики Prometheus: `http://localhost:8000/metrics`.
- Почтовый стенд MailHog: `http://localhost:8025`.

## Частые вопросы

| Симптом | Решение |
| --- | --- |
| Логи кажутся «пустыми» | Убедитесь, что смотрите stdout контейнера (`make logs`); JSON удобно просматривать через `jq`. |
| Нет HTTPS в локальной среде | Проверьте, что переменная `GENERATE_DEV_CERT=1` и каталог `deploy/certs` пуст – прокси сгенерирует self-signed сертификат при старте. |
| Request ID не отображается | Прокси и приложение используют заголовок `X-Request-ID`. Если свой клиент подставляет другой заголовок – приведите к требуемому названию. |
| Приложение отвечает медленно | Посмотрите поля `duration_ms` в логах и метрики `/metrics`. При необходимости увеличьте воркеры через `GUNICORN_WORKERS`. |

