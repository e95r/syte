user  nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid       /var/run/nginx.pid;

load_module modules/ngx_http_brotli_filter_module.so;
load_module modules/ngx_http_brotli_static_module.so;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    map $http_x_request_id $req_id {
        default $http_x_request_id;
        "" $request_id;
    }

    log_format json_combined escape=json '{"timestamp":"$time_iso8601","remote_addr":"$remote_addr","request":"$request","status":$status,"body_bytes_sent":$body_bytes_sent,"request_time":$request_time,"request_id":"$req_id"}';
    access_log /var/log/nginx/access.log json_combined;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;
    keepalive_requests 1000;
    types_hash_max_size 4096;
    server_tokens off;

    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript application/xml text/xml image/svg+xml;

    brotli on;
    brotli_comp_level 5;
    brotli_types text/plain text/css application/json application/javascript application/xml text/xml image/svg+xml;
    brotli_static always;

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m inactive=10m use_temp_path=off;
    proxy_cache_valid 200 301 302 10m;
    proxy_temp_path /var/cache/nginx/tmp;

    limit_req_zone $binary_remote_addr zone=api_rate:10m rate=20r/s;
    limit_req_status 429;

    include /etc/nginx/conf.d/*.conf;
}
